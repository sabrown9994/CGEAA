# Workflow to maintain test coverage map in GitHub Gist
name: Test Coverage Map Sync

# Run on schedule (weekly) or manual trigger
on:
  workflow_dispatch:
  schedule:
    # Run every Sunday at 2 AM UTC
    - cron: '0 2 * * 0'

jobs:
  update-coverage-map:
    runs-on: ubuntu-latest
    
    steps:
      # Write SF auth URL to file
      - name: Write Token to File
        run: "echo ${{ secrets.SFDC_INTQA_SABROWN }} > token.txt"

      # Install NPM
      - name: Install NPM
        run: "npm install -g latest"

      # Install SF CLI
      - name: Install Salesforce CLI
        run: "npm install @salesforce/cli --global"

      # Install jq for JSON processing
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      # Auth to org
      - name: Auth with Org
        run: "sf auth sfdxurl store -f token.txt -a targetOrg -d"

      # Run all local tests with code coverage
      - name: Run All Local Tests
        id: run_tests
        run: |
          echo "Running all local tests with code coverage..."
          
          # Run tests and capture output
          sf apex run test \
            --target-org targetOrg \
            --test-level RunLocalTests \
            --result-format json \
            --concise \
            --synchronous \
            -d test-results || true 
          
          # Check if test results exist (handles dynamic filename with org ID)
          if [ -f test-results/test-result-*.json ]; then
            echo "Test results generated successfully"
            echo "test_success=true" >> $GITHUB_OUTPUT
          else
            echo "Test results file not found"
            echo "test_success=false" >> $GITHUB_OUTPUT
            exit 1
          fi

      # Build coverage map using bash and jq
      - name: Build Coverage Map
        id: build_map
        run: |
          echo "Querying Salesforce for coverage data..."
          
          # Query ApexCodeCoverage for detailed mapping
          QUERY="SELECT ApexClassOrTrigger.Name, ApexTestClass.Name FROM ApexCodeCoverage WHERE ApexClassOrTrigger.Name != null AND ApexTestClass.Name != null ORDER BY ApexClassOrTrigger.Name"
          
          sf data query \
            --query "$QUERY" \
            --target-org targetOrg \
            --use-tooling-api \
            --json \
            > coverage-query.json
          
          # Check if query returned results
          RECORD_COUNT=$(jq -r '.result.records | length' coverage-query.json 2>/dev/null || echo "0")
          
          if [ "$RECORD_COUNT" -eq 0 ]; then
            echo "Warning: No coverage data found"
            echo "Tests may not have generated coverage data"
            exit 1
          fi
          
          echo "Found $RECORD_COUNT coverage records"
          
          # Build coverage map using jq
          jq -r '{
            "version": "1.0",
            "lastUpdated": (now | strftime("%Y-%m-%dT%H:%M:%SZ")),
            "description": "Salesforce Test Coverage Map - Maps Apex classes to their test classes",
            "recordCount": (.result.records | length),
            "coverage": (
              .result.records
              | group_by(.ApexClassOrTrigger.Name)
              | map({
                  key: .[0].ApexClassOrTrigger.Name,
                  value: (map(.ApexTestClass.Name) | unique | sort)
                })
              | from_entries
            )
          }' coverage-query.json > final-coverage-map.json
          
          # Verify the final map was created
          if [ -f "final-coverage-map.json" ]; then
            CLASS_COUNT=$(jq '.coverage | length' final-coverage-map.json)
            RECORD_COUNT=$(jq '.recordCount' final-coverage-map.json)
            echo "class_count=$CLASS_COUNT" >> $GITHUB_OUTPUT
            echo "record_count=$RECORD_COUNT" >> $GITHUB_OUTPUT
            echo "Coverage map created with $CLASS_COUNT classes and $RECORD_COUNT coverage records"
          else
            echo "Failed to create coverage map"
            exit 1
          fi

      # Upload coverage map to GitHub Gist
      - name: Deploy to Gist
        uses: exuanbo/actions-deploy-gist@v1
        with:
            token: ${{ secrets.GIST_TOKEN }}
            gist_id: 4276fb0054b3a999b256d8bcb9cb742d
            file_path: final-coverage-map.json
            file_type: json
