#!/bin/bash

# CGEAA Setup Script
# Initializes CGEAA configuration and sets up the environment

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
CGEAA_LIB_DIR="${SCRIPT_DIR}/cgeaa-lib"

# Source utility functions
source "${CGEAA_LIB_DIR}/utils.sh"
source "${CGEAA_LIB_DIR}/config.sh"

# Colors for output
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
NC='\033[0m'

echo -e "${BLUE}"
cat << 'EOF'
   ______ _____ ______ ___          
  / ____// ____// ____//   |   /\    
 / /    / / __ / __/  / /| |  /  \   
/ /___ / /_/ // /___ / ___ | / /\ \  
\____/ \____//_____//_/  |_|/_/  \_\ 

CarGurus Enterprise Applications Automation
Setup & Configuration
EOF
echo -e "${NC}"

# Check if we're in the right directory
if [ ! -f "cgeaa" ]; then
    echo -e "${RED}Error: cgeaa script not found in current directory${NC}"
    echo "Please run this setup script from the directory containing the cgeaa script"
    exit 1
fi

echo "Setting up CGEAA environment..."
echo

# Make sure cgeaa script is executable
chmod +x cgeaa
echo "✓ Made cgeaa script executable"

# Create global config directory
GLOBAL_CONFIG_DIR="$HOME/.cgeaa"
if [ ! -d "$GLOBAL_CONFIG_DIR" ]; then
    mkdir -p "$GLOBAL_CONFIG_DIR"
    echo "✓ Created global config directory: $GLOBAL_CONFIG_DIR"
fi

# Create global config file if it doesn't exist
GLOBAL_CONFIG_FILE="$GLOBAL_CONFIG_DIR/config"
if [ ! -f "$GLOBAL_CONFIG_FILE" ]; then
    create_sample_config "$GLOBAL_CONFIG_FILE"
    echo "✓ Created global configuration file"
else
    echo "✓ Global configuration file already exists"
fi

# Create project config directory
PROJECT_CONFIG_DIR=".cgeaa"
if [ ! -d "$PROJECT_CONFIG_DIR" ]; then
    mkdir -p "$PROJECT_CONFIG_DIR"
    echo "✓ Created project config directory: $PROJECT_CONFIG_DIR"
fi

# Create project config file if it doesn't exist
PROJECT_CONFIG_FILE="$PROJECT_CONFIG_DIR/config"
if [ ! -f "$PROJECT_CONFIG_FILE" ]; then
    create_sample_config "$PROJECT_CONFIG_FILE"
    echo "✓ Created project configuration file"
else
    echo "✓ Project configuration file already exists"
fi

# Add cgea to PATH suggestion
echo
echo -e "${YELLOW}Optional: Add CGEAA to your PATH${NC}"
echo "To use 'cgeaa' from anywhere, add this line to your ~/.bashrc or ~/.zshrc:"
echo "export PATH=\"$SCRIPT_DIR:\$PATH\""
echo

# Check dependencies
echo "Checking dependencies..."
check_dependencies
echo "✓ All dependencies are available"

# Test basic functionality
echo
echo "Testing CGEAA installation..."
if ./cgeaa version > /dev/null 2>&1; then
    echo "✓ CGEAA is working correctly"
else
    echo -e "${RED}✗ CGEAA test failed${NC}"
    exit 1
fi

echo
echo -e "${GREEN}CGEAA setup completed successfully!${NC}"
echo
echo "Next steps:"
echo "1. Review and customize the configuration files:"
echo "   - Global: $GLOBAL_CONFIG_FILE"
echo "   - Project: $PROJECT_CONFIG_FILE"
echo
echo "2. Authenticate to your Salesforce orgs:"
echo "   sf auth web login --alias targetOrg"
echo
echo "3. Try running CGEAA:"
echo "   ./cgeaa validate --dry-run"
echo "   ./cgeaa deploy --dry-run"
echo
echo "For help, run: ./cgeaa help"
